# 拾光记忆 - 云服务器部署文档

## 目录

1. [环境要求](#环境要求)
2. [配置修改清单](#配置修改清单)
3. [部署方式一：Docker Compose（推荐）](#部署方式一docker-compose推荐)
4. [部署方式二：手动部署](#部署方式二手动部署)
5. [Nginx 反向代理配置](#nginx-反向代理配置)
6. [HTTPS 配置](#https-配置)
7. [数据备份与恢复](#数据备份与恢复)
8. [常见问题排查](#常见问题排查)
9. [安全加固建议](#安全加固建议)

---

## 环境要求

### 服务器配置
| 项目 | 最低要求 | 推荐配置 |
|------|----------|----------|
| CPU | 1核 | 2核+ |
| 内存 | 1GB | 2GB+ |
| 硬盘 | 10GB | 20GB+（根据图片存储需求） |

### 软件依赖

#### Docker 部署方式
- Docker 20.10+
- Docker Compose 2.0+

#### 手动部署方式
- Python 3.9+
- Node.js 18+
- Nginx 1.18+

---

## 配置修改清单

### ⚠️ 必须修改的配置

#### 1. 后端环境变量 (`backend/.env`)

```bash
# 【必须修改】安全密钥 - 用于 JWT 加密，请生成随机字符串
SECRET_KEY=your_super_secret_key_at_least_32_characters_long

# 【必须修改】默认管理员密码 - 首次启动时创建
DEFAULT_ADMIN_PASSWORD=your_strong_password_here

# 【建议修改】管理员用户名
DEFAULT_ADMIN_USERNAME=admin

# 【建议修改】管理员出生日期
DEFAULT_ADMIN_DOB_STR=1990-01-01
```

**生成随机密钥的方法：**
```bash
# Linux/Mac
openssl rand -hex 32

# 或使用 Python
python3 -c "import secrets; print(secrets.token_hex(32))"
```

#### 2. Docker Compose (`docker-compose.yml`)

```yaml
environment:
  # 【必须修改】与 backend/.env 中的 SECRET_KEY 保持一致
  - SECRET_KEY=your_super_secret_key_at_least_32_characters_long
```

### 可选修改的配置

#### 后端配置 (`backend/.env`)

```bash
# Token 过期时间（分钟），默认约20天
ACCESS_TOKEN_EXPIRE_MINUTES=30000

# 调试模式（生产环境必须为 false）
DEBUG=false

# 最大上传图片大小（MB）
MAX_IMAGE_SIZE_MB=10

# 缩略图最大尺寸（像素）
THUMBNAIL_MAX_SIZE=800
```

#### 端口配置 (`docker-compose.yml`)

```yaml
# 后端端口（如需外部直接访问）
ports:
  - "8000:8000"  # 可改为 "127.0.0.1:8000:8000" 只允许本地访问

# 前端端口
ports:
  - "80:80"      # HTTP
  - "443:443"    # HTTPS（如果配置了）
```

---

## 部署方式一：Docker Compose（推荐）

### 步骤 1：安装 Docker

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install -y docker.io docker-compose-plugin

# 启动 Docker 服务
sudo systemctl start docker
sudo systemctl enable docker

# 将当前用户加入 docker 组（需重新登录生效）
sudo usermod -aG docker $USER
```

### 步骤 2：上传项目文件

```bash
# 方式一：通过 Git 克隆
git clone https://github.com/SJcun/memento.git
cd memento

# 方式二：通过 SCP 上传
scp -r ./memento user@your-server:/home/user/
```

### 步骤 3：修改配置

```bash
cd memento

# 编辑后端环境变量
nano backend/.env

# 编辑 Docker Compose 配置
nano docker-compose.yml
```

**修改 `backend/.env`：**
```bash
SECRET_KEY=生成的随机密钥
DEFAULT_ADMIN_PASSWORD=你的管理员密码
```

**修改 `docker-compose.yml`：**
```yaml
environment:
  - SECRET_KEY=与上面相同的密钥
```

### 步骤 4：检查前端 Dockerfile

确保 `frontend/Dockerfile` 内容正确：

```dockerfile
# 构建阶段
FROM node:18-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

# 运行阶段
FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

### 步骤 5：构建并启动

```bash
# 构建镜像
docker compose build

# 启动服务（后台运行）
docker compose up -d

# 查看运行状态
docker compose ps

# 查看日志
docker compose logs -f
```

### 步骤 6：验证部署

```bash
# 检查容器状态
docker compose ps

# 测试后端 API
curl http://localhost:8000/docs

# 测试前端
curl http://localhost
```

浏览器访问：`http://你的服务器IP`

---

## 部署方式二：手动部署

### 步骤 1：安装依赖

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install -y python3 python3-pip python3-venv nodejs npm nginx

# CentOS
sudo yum install -y python3 python3-pip nodejs npm nginx
```

### 步骤 2：部署后端

```bash
cd memento/backend

# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 修改配置
cp .env.example .env  # 如果有示例文件
nano .env             # 编辑配置

# 创建必要目录
mkdir -p data uploads/originals uploads/thumbnails

# 启动服务（开发测试）
python main.py

# 生产环境使用 systemd 管理（见下方）
```

**创建 systemd 服务文件** (`/etc/systemd/system/memento-api.service`)：

```ini
[Unit]
Description=Memento API Server
After=network.target

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=/home/user/memento/backend
Environment="PATH=/home/user/memento/backend/venv/bin"
ExecStart=/home/user/memento/backend/venv/bin/uvicorn main:app --host 127.0.0.1 --port 8000
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

```bash
# 启动服务
sudo systemctl daemon-reload
sudo systemctl start memento-api
sudo systemctl enable memento-api

# 查看状态
sudo systemctl status memento-api
```

### 步骤 3：部署前端

```bash
cd memento/frontend

# 安装依赖
npm install

# 构建生产版本
npm run build

# 复制到 Nginx 目录
sudo cp -r dist/* /var/www/memento/
```

### 步骤 4：配置 Nginx

创建 `/etc/nginx/sites-available/memento`：

```nginx
server {
    listen 80;
    server_name your-domain.com;  # 替换为你的域名或IP

    # 前端静态文件
    root /var/www/memento;
    index index.html;

    # API 代理
    location /api/ {
        proxy_pass http://127.0.0.1:8000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 上传文件大小限制
        client_max_body_size 20M;
    }

    # 静态资源代理（图片）
    location /static/ {
        proxy_pass http://127.0.0.1:8000/static/;
        proxy_set_header Host $host;
    }

    # React Router 支持
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 缓存静态资源
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
```

```bash
# 启用站点
sudo ln -s /etc/nginx/sites-available/memento /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
```

---

## 数据备份与恢复

### 重要数据位置

| 数据类型 | Docker 位置 | 手动部署位置 |
|----------|-------------|--------------|
| 数据库 | `./data/memento.db` | `backend/data/memento.db` |
| 原图 | `./uploads/originals/` | `backend/uploads/originals/` |
| 缩略图 | `./uploads/thumbnails/` | `backend/uploads/thumbnails/` |

---

## 常见问题排查

### 1. 容器启动失败

```bash
# 查看日志
docker compose logs backend
docker compose logs frontend

# 常见问题：
# - 端口被占用：修改 docker-compose.yml 中的端口
# - 权限问题：确保 data 和 uploads 目录有写权限
```

### 2. 无法访问网站

```bash
# 检查防火墙
sudo ufw status
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 检查端口监听
sudo netstat -tlnp | grep -E '80|443|8000'

# 检查 Nginx 状态
sudo systemctl status nginx
sudo nginx -t
```

### 3. API 请求 502 错误

```bash
# 检查后端服务是否运行
docker compose ps
# 或
sudo systemctl status memento-api

# 检查后端日志
docker compose logs backend
# 或
sudo journalctl -u memento-api -f
```

### 4. 图片无法显示

```bash
# 检查上传目录权限
ls -la uploads/

# Docker 环境修复
docker compose exec backend chmod -R 755 /app/uploads

# 手动部署环境修复
sudo chown -R www-data:www-data uploads/
sudo chmod -R 755 uploads/
```

### 5. 数据库锁定错误

```bash
# SQLite 并发问题，检查是否有多个进程访问
fuser data/memento.db

# 重启服务通常可以解决
docker compose restart backend
```

---

## 安全加固建议

### 1. 修改默认配置

- ✅ 修改 `SECRET_KEY` 为随机字符串（至少32位）
- ✅ 修改默认管理员密码
- ✅ 生产环境设置 `DEBUG=false`

### 2. 网络安全

```bash
# 只允许 Nginx 访问后端（docker-compose.yml）
ports:
  - "127.0.0.1:8000:8000"  # 只监听本地

# 配置防火墙
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

### 3. 定期更新

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 更新 Docker 镜像
docker compose pull
docker compose up -d --build
```

### 4. 日志监控

```bash
# 查看访问日志
sudo tail -f /var/log/nginx/access.log

# 查看错误日志
sudo tail -f /var/log/nginx/error.log

# Docker 日志
docker compose logs -f --tail=100
```

### 5. 资源限制

`docker-compose.yml` 中已配置资源限制：

```yaml
deploy:
  resources:
    limits:
      cpus: '1.0'
      memory: 512M  # 根据服务器配置调整
```

---

## 快速部署检查清单

- [ ] 修改 `backend/.env` 中的 `SECRET_KEY`
- [ ] 修改 `backend/.env` 中的 `DEFAULT_ADMIN_PASSWORD`
- [ ] 修改 `docker-compose.yml` 中的 `SECRET_KEY`
- [ ] 确认 `frontend/Dockerfile` 内容完整
- [ ] 开放防火墙端口 (80, 443)
- [ ] 配置 HTTPS（生产环境强烈推荐）
- [ ] 设置自动备份
- [ ] 测试登录功能
- [ ] 测试图片上传功能

---

## 升级指南

```bash
# 1. 备份数据
./backup-memento.sh

# 2. 拉取最新代码
git pull origin main

# 3. 重新构建
docker compose down
docker compose build --no-cache
docker compose up -d

# 4. 验证服务
docker compose ps
curl http://localhost/api/docs
```
